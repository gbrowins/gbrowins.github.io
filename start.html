<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="/favicon.png">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gregg's Mobile Home Page</title>
<style>
:root{
  --bg-light:#fafafa;--bg-dark:#1e1e1e;
  --fg-light:#000;--fg-dark:#fff;
  --card-bg-light:#fff;--card-bg-dark:#2c2c2c;
}
body{margin:0;font-family:Arial,system-ui,sans-serif;background:var(--bg-light);color:var(--fg-light);transition:background .25s,color .25s}
body.dark{background:var(--bg-dark);color:var(--fg-dark)}
header{display:flex;align-items:center;justify-content:space-between;padding:10px 15px;position:sticky;top:0;background:inherit;z-index:10}
#search-container{flex:0 0 80%;margin-right:10px}
#search{width:100%;padding:8px 10px;border:1px solid #999;border-radius:5px;font-size:16px}
#settings-button{background:none;border:none;font-size:22px;cursor:pointer;color:inherit;position:relative;z-index:20}
#settings-menu{position:absolute;right:15px;top:45px;background:var(--card-bg-light);border:1px solid #ccc;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.2);display:none;z-index:30}
body.dark #settings-menu{background:var(--card-bg-dark);border-color:#555}
#settings-menu button{display:block;width:100%;padding:10px 15px;border:none;background:none;color:inherit;text-align:left;cursor:pointer;font-size:15px}
#settings-menu button:hover{background:rgba(0,0,0,.08)}

#shortcuts{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:15px;padding:15px}

.shortcut{position:relative;text-align:center;background:var(--card-bg-light);border-radius:8px;padding:15px;box-shadow:0 2px 4px rgba(0,0,0,.12);transition:transform .18s,box-shadow .18s,border .18s;cursor:grab;user-select:none;touch-action:none}
body.dark .shortcut{background:var(--card-bg-dark)}
.shortcut:active{cursor:grabbing}
.shortcut:hover{transform:scale(1.03)}
.shortcut img{width:32px;height:32px;margin-bottom:8px;display:block;margin-left:auto;margin-right:auto;pointer-events:none;-webkit-touch-callout:none;-webkit-user-drag:none}

/* glow in edit mode */
.shortcut.show-icons{box-shadow:0 0 16px 4px rgba(255,160,0,.65);}

/* separate edit/delete buttons */
.shortcut .edit-btn,.shortcut .delete-btn{
  position:absolute;background:rgba(0,0,0,.5);border:none;color:#fff;border-radius:4px;padding:3px 5px;cursor:pointer;font-size:12px;opacity:0;transition:opacity .18s,transform .12s;z-index:5;pointer-events:auto;touch-action:none
}
.shortcut.show-icons .edit-btn,.shortcut.show-icons .delete-btn{opacity:1}
.shortcut .edit-btn{top:6px;left:6px}
.shortcut .delete-btn{top:6px;right:6px}
.shortcut .edit-btn:active,.shortcut .delete-btn:active{transform:scale(.95)}

/* drag over indicator */
.drag-over{outline:2px dashed #666;transform:scale(1.02)}

/* modal */
#add-dialog {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
  backdrop-filter: blur(5px);
  z-index: 50;
  align-items: flex-start; /* align to top instead of center */
  justify-content: center;
  padding-top: 10vh; /* push form down a bit from top */
}

#add-dialog form {
  background: var(--card-bg-light);
  color: inherit;
  padding: 20px;
  border-radius: 8px;
  min-width: 280px;
  max-width: 90vw;
  box-shadow: 0 2px 10px rgba(0,0,0,.35);
  font-size: 1.25em;
}

#add-dialog input,
#add-dialog button {
  font-size: 1em; /* ensures inputs/buttons scale with form size */
}

body.dark #add-dialog form{background:var(--card-bg-dark)}
#add-dialog input{width:80%;margin:0 10%;margin-bottom:10px;padding:8px;border-radius:5px;border:1px solid #999}
#add-dialog button{margin-right:8px;padding:8px 12px;border:none;border-radius:5px;cursor:pointer}
.small-btn{font-size:0.9rem;padding:.3rem .6rem;border-radius:6px}

.shortcut.add-tile {
  background: none;
  border: 2px dashed #999;
  box-shadow: none;
  color: inherit;
  cursor: pointer;
  user-select: none;
  transition: background .2s, transform .18s;
}
.shortcut.add-tile:hover {
  background: rgba(0,0,0,0.05);
  transform: scale(1.03);
}
body.dark .shortcut.add-tile {
  border-color: #777;
}
body.dark .shortcut.add-tile:hover {
  background: rgba(255,255,255,0.08);
}

</style>
</head>
<body>
<header>
  <div id="search-container"><input id="search" type="text" placeholder="Search DuckDuckGo..." /></div>
  <button id="settings-button" title="Settings">⋮</button>
</header>

<div id="settings-menu" role="menu" aria-hidden="true">
  <button id="add-shortcut-btn" class="small-btn">Add Shortcut</button>
  <button id="toggle-theme" class="small-btn">Toggle Dark/Light</button>
  <button id="import-btn" class="small-btn">Import Shortcuts</button>
  <button id="export-btn" class="small-btn">Export Shortcuts</button>
</div>

<div id="shortcuts" aria-live="polite"></div>

<div id="add-dialog" aria-modal="true" role="dialog">
  <form id="add-form">
    <h3 id="dialog-title">Add Shortcut</h3>
    <input id="shortcut-name" type="text" placeholder="Name" required />
    <input id="shortcut-url" type="url" value="https://www.example.com" required />
    <div style="text-align:right">
      <button type="submit" id="add-save-btn">Add</button>
      <button type="button" id="cancel-add">Cancel</button>
    </div>
  </form>
</div>

<script>
/* helpers */
const $ = id => document.getElementById(id);
const shortcutsEl = $('shortcuts');
const search = $('search');
const settingsButton = $('settings-button');
const settingsMenu = $('settings-menu');
const toggleThemeBtn = $('toggle-theme');
const addShortcutBtn = $('add-shortcut-btn');
const addDialog = $('add-dialog');
const addForm = $('add-form');
const cancelAdd = $('cancel-add');
const addSaveBtn = $('add-save-btn');
const dialogTitle = $('dialog-title');
const importBtn = $('import-btn');
const exportBtn = $('export-btn');

let suppressClickUntil = 0;

let shortcuts = JSON.parse(localStorage.getItem('shortcuts') || '[]')
  .map(s => ({ name: s.name || s.title || 'Unnamed', url: s.url || s.href || '' }));
let editIndex = null;

/* document-level click: close edit mode & settings if click outside tiles/menu */
document.addEventListener('click', (ev) => {
  if (settingsButton.contains(ev.target) || settingsMenu.contains(ev.target)) return;
  if (ev.target.closest('.shortcut')) return;
  document.querySelectorAll('.shortcut.show-icons').forEach(t => t.classList.remove('show-icons'));
  settingsMenu.style.display = 'none';
});

/* render */
function renderShortcuts(){
  shortcutsEl.innerHTML = '';
  shortcuts.forEach((s, i) => {
    const tile = document.createElement('div');
    tile.className = 'shortcut';
    tile.dataset.index = i;
    tile.draggable = true;

    const favicon = document.createElement('img');
    try { favicon.src = s.url ? `https://www.google.com/s2/favicons?sz=64&domain_url=${new URL(s.url).origin}` : ''; } catch(e){ favicon.src=''; }

    const label = document.createElement('div'); label.textContent = s.name || 'Unnamed';

    const editBtn = document.createElement('button'); editBtn.className='edit-btn'; editBtn.innerText='✏️'; editBtn.title='Edit';
    const delBtn  = document.createElement('button'); delBtn.className='delete-btn'; delBtn.innerText='❌'; delBtn.title='Delete';

    /* Prevent tile handlers from running when interacting with these buttons.
       Use pointerdown to immediately consume pointer and avoid other handlers. */
    const consume = e => { e.stopPropagation(); if (e.preventDefault) e.preventDefault(); };

    editBtn.addEventListener('pointerdown', consume, {passive:false});
    delBtn.addEventListener('pointerdown', consume, {passive:false});

    // pointerup triggers action (works for mouse and touch)
    editBtn.addEventListener('pointerup', (ev) => {
      ev.stopPropagation();
      ev.preventDefault();
      openEditModal(i);
    }, {passive:false});
    delBtn.addEventListener('pointerup', (ev) => {
      ev.stopImmediatePropagation();
      ev.preventDefault();
      if (confirm('Delete this shortcut?')) { 
        // suppress the next click for a short window so a reflowed Add tile can't receive it
        suppressClickUntil = Date.now() + 1000;
        shortcuts.splice(i,1); 
        saveAndRender(); 
      }
    }, {passive:false});

    tile.appendChild(editBtn);
    tile.appendChild(delBtn);
    tile.appendChild(favicon);
    tile.appendChild(label);
    shortcutsEl.appendChild(tile);

    /* ---- pointer-based interaction for tile ----
       pointerdown -> start longpress timer and record coords
       pointermove -> detect movement (>threshold) => dragging candidate
       pointerup   -> if dragging => perform reorder on touch; if short tap => open url; if longpress fired => nothing (icons shown)
    */
    let pointerId = null;
    let startX = 0, startY = 0;
    let moved = false;
    let longPressFired = false;
    let longPressTimer = null;
    const LONG_PRESS_MS = 600;
    const MOVE_THRESHOLD = 8;

    function startPointer(ev){
      // only handle primary button/pointer
      if (ev.isPrimary === false) return;
      pointerId = ev.pointerId;
      moved = false;
      longPressFired = false;
      startX = ev.clientX;
      startY = ev.clientY;
      // start long press timer
      clearLongPress();
      longPressTimer = setTimeout(() => {
        longPressFired = true;
        tile.classList.add('show-icons');
      }, LONG_PRESS_MS);
      // capture pointer so we get moves/up even if pointer leaves
      try { tile.setPointerCapture(pointerId); } catch(e){}
    }
    function movePointer(ev){
      if (ev.pointerId !== pointerId) return;
      const dx = Math.abs(ev.clientX - startX), dy = Math.abs(ev.clientY - startY);
      if (dx > MOVE_THRESHOLD || dy > MOVE_THRESHOLD){
        moved = true;
        clearLongPress();
        // highlight potential drop target
        const under = document.elementFromPoint(ev.clientX, ev.clientY);
        const potential = under ? under.closest('.shortcut') : null;
        document.querySelectorAll('.shortcut').forEach(n=>n.classList.remove('drag-over'));
        if (potential && potential !== tile) potential.classList.add('drag-over');
      }
    }
    function endPointer(ev){
      if (ev.pointerId !== pointerId) return;
      clearLongPress();
      try { tile.releasePointerCapture(pointerId); } catch(e){}
      document.querySelectorAll('.shortcut').forEach(n=>n.classList.remove('drag-over'));
      // if moved -> reorder (touch style)
      if (moved){
        const under = document.elementFromPoint(ev.clientX, ev.clientY);
        const target = under ? under.closest('.shortcut') : null;
        if (target && target !== tile){
          const from = parseInt(tile.dataset.index,10);
          const to   = parseInt(target.dataset.index,10);
          if (!Number.isNaN(from) && !Number.isNaN(to) && from !== to){
            const movedItem = shortcuts.splice(from,1)[0];
            shortcuts.splice(to,0,movedItem);
            saveAndRender();
          }
        }
        pointerId = null; moved=false;
        return;
      }
      // if long press was fired, we already showed icons; don't open URL on release
      if (longPressFired){ pointerId = null; return; }

      // short tap -> open url (but ensure the tap wasn't on a button; buttons consumed pointerdown so won't reach here)
      if (!moved){
        if (s.url) window.open(s.url, '_blank');
      }
      pointerId = null;
    }
    function cancelPointer(ev){
      if (ev.pointerId !== pointerId) return;
      clearLongPress();
      try{ tile.releasePointerCapture(pointerId);}catch(e){}
      pointerId = null; moved=false;
    }
    function clearLongPress(){ if (longPressTimer){ clearTimeout(longPressTimer); longPressTimer=null; } }

    tile.addEventListener('pointerdown', startPointer, {passive:false});
    tile.addEventListener('pointermove', movePointer, {passive:true});
    tile.addEventListener('pointerup', endPointer, {passive:false});
    tile.addEventListener('pointercancel', cancelPointer, {passive:false});

    /* desktop native drag/drop (mouse) still supported */
    tile.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', tile.dataset.index); tile.classList.add('dragging'); });
    tile.addEventListener('dragend', () => { tile.classList.remove('dragging'); document.querySelectorAll('.drag-over').forEach(n=>n.classList.remove('drag-over')); });
    tile.addEventListener('dragover', (e) => { e.preventDefault(); if (!tile.classList.contains('dragging')) tile.classList.add('drag-over'); });
    tile.addEventListener('dragleave', () => tile.classList.remove('drag-over'));
    tile.addEventListener('drop', (e) => {
      e.preventDefault();
      const from = parseInt(e.dataTransfer.getData('text/plain'),10);
      const to = parseInt(tile.dataset.index,10);
      tile.classList.remove('drag-over');
      if (!Number.isNaN(from) && !Number.isNaN(to) && from !== to){
        const movedItem = shortcuts.splice(from,1)[0];
        shortcuts.splice(to,0,movedItem);
        saveAndRender();
      }
    });
  });
  // ensure dataset indices are correct
  document.querySelectorAll('.shortcut').forEach((t,idx)=> t.dataset.index = idx);

  // --- Add the persistent "Add New" tile at the end ---
  const addTile = document.createElement('div');
  addTile.className = 'shortcut add-tile';
  addTile.innerHTML = `<div style="font-size:36px;line-height:1;margin-bottom:8px;">＋</div><div>Add New...</div>`;
  addTile.addEventListener('click', () => {
    // ignore a single follow-up click that may arrive immediately after a delete
    if (Date.now() < suppressClickUntil) {
      ev.stopPropagation();
      ev.preventDefault();
      return;
    }
    
    editIndex = null;
    dialogTitle.textContent = 'Add Shortcut';
    addSaveBtn.textContent = 'Add';
    addForm.reset();
    addDialog.style.display = 'flex';
    setTimeout(() => $('shortcut-name').focus(), 100);
  });
  shortcutsEl.appendChild(addTile);
}

/* save + render */
function saveAndRender(){ localStorage.setItem('shortcuts', JSON.stringify(shortcuts)); renderShortcuts(); }

/* search */
search.addEventListener('keydown', (e) => { if (e.key==='Enter'){ const q=encodeURIComponent(search.value.trim()); if (q) window.location.href=`https://duckduckgo.com/?q=${q}`;} });

/* settings menu */
settingsButton.addEventListener('click', (ev)=>{ ev.stopPropagation(); settingsMenu.style.display = settingsMenu.style.display === 'block' ? 'none' : 'block'; });

/* theme */
if (localStorage.getItem('theme')==='dark') document.body.classList.add('dark');
toggleThemeBtn.addEventListener('click', ()=>{ document.body.classList.toggle('dark'); localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light'); });

/* modal add/edit */
function openEditModal(index){
  editIndex = index;
  dialogTitle.textContent = 'Edit Shortcut';
  addSaveBtn.textContent = 'Save';
  $('shortcut-name').value = shortcuts[index].name;
  $('shortcut-url').value = shortcuts[index].url;
  addDialog.style.display = 'flex';
  setTimeout(() => $('shortcut-name').focus(), 100);
}
addShortcutBtn.addEventListener('click', ()=>{ editIndex=null; dialogTitle.textContent='Add Shortcut'; addSaveBtn.textContent='Add'; addForm.reset(); addDialog.style.display='flex'; setTimeout(() => $('shortcut-name').focus(), 100); });
cancelAdd.addEventListener('click', ()=>{ addDialog.style.display='none'; editIndex=null; });
addForm.addEventListener('submit', (ev)=>{ ev.preventDefault(); const name=$('shortcut-name').value.trim(); const url=$('shortcut-url').value.trim(); if(!name||!url) return; if(editIndex!==null) shortcuts[editIndex]={name,url}; else shortcuts.push({name,url}); saveAndRender(); addDialog.style.display='none'; editIndex=null; });

/* export/import */
exportBtn.addEventListener('click', ()=>{ const b=new Blob([JSON.stringify(shortcuts,null,2)],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='shortcuts.json'; a.click(); URL.revokeObjectURL(u); });
importBtn.addEventListener('click', ()=>{ const input=document.createElement('input'); input.type='file'; input.accept='application/json'; input.onchange = (e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const d=JSON.parse(r.result); if(Array.isArray(d)){ shortcuts = d.map(s => ({ name: s.name || s.title || 'Unnamed', url: s.url || s.href || '' })); saveAndRender(); } else alert('Invalid file format'); } catch(err){ alert('Invalid file'); } }; r.readAsText(f); }; input.click(); });

/* initial render */
renderShortcuts();
</script>
</body>
</html>
